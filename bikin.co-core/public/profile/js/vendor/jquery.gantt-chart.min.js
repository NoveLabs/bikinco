!function(w){w.fn.ganttView=function(){var e=Array.prototype.slice.call(arguments);1===e.length&&"object"==typeof e[0]&&function(e){var a=this,i=w.extend(!0,{highlightWeekends:!0,highlightToday:!0,toggleableProjects:!0,cellWidth:20,slideWidth:400,kineticScroll:!0,startDate:!1,endDate:!1,startToday:!1,behavior:{clickable:!1,draggable:!0,resizable:!0}},e);i.data?t():i.dataUrl&&w.getJSON(i.dataUrl,function(e){i.data=e,t()});function t(){var e=Math.floor(i.slideWidth/i.cellWidth+5),t=f.getBoundaryDatesFromData(i.data,e);i.start=i.startDate?moment(i.startDate,"MM/DD/YYYY")._d:t[0],i.end=i.endDate?moment(i.endDate,"MM/DD/YYYY")._d:t[1],a.each(function(){var e=w(this),t=w("<div>",{class:"ganttview"});new n(t,i).render(),e.append(t);w("div.ganttview-vtheader",e).outerWidth(),w("div.ganttview-slide-container",e).outerWidth();new s(e,i).apply()})}}.call(this,e[0]),2===e.length&&"string"==typeof e[0]&&function(e,t){{var a;"setSlideWidth"===e&&(a=$("div.ganttview",this)).each(function(){var e=$("div.ganttview-vtheader",a).outerWidth();$(a).width(e+t+1),$("div.ganttview-slide-container",this).width(t)})}}.call(this,e[0],e[1])};var n=function(d,r){function u(e,t,a){var i={parent:t.name};w.extend(i,a),e.data("block-data",i)}return{render:function(){!function(e,t){for(var a=w("<div>",{class:"ganttview-vtheader"}),i=0;i<t.length;i++){var n=w("<div>",{class:"ganttview-vtheader-group"});n.append(w("<div>",{class:"ganttview-vtheader-group-name",id:"groupId_"+i}).append(t[i].name).append("<span/>"));for(var s=w("<div>",{class:"ganttview-vtheader-series"}),d=0;d<t[i].series.length;d++){var r=w("<div>",{class:"ganttview-vtheader-series-row"});if(t[i].series[d].sub_series){var o=w("<div>",{class:"series-content"}),l=w("<div>",{class:"series-dates"}),c=w("<div>",{class:"series-users"});o.append('<div class="series-name">'+t[i].series[d].name+"</div>");for(var v=0;v<t[i].series[d].sub_series.length;v++){var g,h,p,m=0<v?'<span class="date-sep">|</span>':"",u=t[i].series[d].sub_series[v];u.user_avatar&&(g=w("<div>",{class:"series-user"}),h=u.user_name,p=u.user_avatar,g.append('<span><img src="'+p+'" alt="'+h+'" title="'+h+'"/></span>'),c.append(g),r.append(c)),l.append(function(){return m+"<span data-event-id='"+t[i].series[d].sub_series[v].id+"'>"+moment(u.start,"MM/DD/YYYY").format("D MMM")+" - "+moment(u.end,"MM/DD/YYYY").format("D MMM")+"</span>"}),o.append(l),r.append(o)}}else r.append(function(){return(t[i].series[d].user_avatar?"<div class='series-user'><span><img src='"+t[i].series[d].user_avatar+"' alt='"+t[i].series[d].user_name+"' title='"+t[i].series[d].user_name+"'/></span></div>":"")+"<div class='series-content'><div class=\"series-name\">"+t[i].series[d].name+"</div><div class='series-dates'><span data-event-id='"+t[i].series[d].id+"'>"+moment(t[i].series[d].start,"MM/DD/YYYY").format("D MMM")+" - "+moment(t[i].series[d].end,"MM/DD/YYYY").format("D MMM")+"</span></div></div>"});s.append(r)}n.append(s),a.append(n)}e.append(a)}(d,r.data);var e,t,a,i,n=w("<div>",{class:"ganttview-slide-container"}),s=function(e,t){var a=[];a[e.getFullYear()]=[],a[e.getFullYear()][e.getMonth()]=[e];var i=e;for(;moment(t).isAfter(i);){var n=moment(i).add(1,"days")._d;a[n.getFullYear()]||(a[n.getFullYear()]=[]),a[n.getFullYear()][n.getMonth()]||(a[n.getFullYear()][n.getMonth()]=[]),a[n.getFullYear()][n.getMonth()].push(n),i=n}return a}(r.start,r.end);!function(e,t,a,i,n,s){var d=w("<div>",{class:"ganttview-hzheader"}),r=w("<div>",{class:"ganttview-hzheader-months"}),o=w("<div>",{class:"ganttview-hzheader-days"}),l=0;for(var c in t)for(var v in t[c]){var g=t[c][v].length*a;for(var h in l+=g,r.append(w("<div>",{class:"ganttview-hzheader-month",css:{width:g-1+"px"}}).append(moment(parseInt(v)+1,"M").format("MMMM")+" "+c)),t[c][v]){var p=w("<div>",{class:"ganttview-hzheader-day"});f.isWeekend(t[c][v][h])&&i&&p.addClass("ganttview-weekend"),moment(t[c][v][h]).isSame(Date.now(),"day")&&n&&p.addClass("ganttview-today"),moment(t[c][v][h]).isSame(Date.now(),"day")&&s&&p.addClass("ganttview-startToday"),o.append(p.append(t[c][v][h].getDate()))}}r.css("width",l+"px"),o.css("width",l+"px"),d.append(r).append(o),e.append(d)}(n,s,r.cellWidth,r.highlightWeekends,r.highlightToday,r.startToday),function(e,t,a,i,n,s){var d=w("<div>",{class:"ganttview-grid"}),r=w("<div>",{class:"ganttview-grid-row"});for(var o in a)for(var l in a[o])for(var c in a[o][l]){var v=w("<div>",{class:"ganttview-grid-row-cell"});f.isWeekend(a[o][l][c])&&n&&v.addClass("ganttview-weekend"),moment(a[o][l][c]).isSame(Date.now(),"day")&&s&&v.addClass("ganttview-today"),r.append(v)}var g=w("div.ganttview-grid-row-cell",r).length*i;r.css("width",g+"px"),d.css("width",g+"px");for(var h=0;h<t.length;h++){d.append(w("<div>",{class:"ganttview-grid-spacer","data-click-target":"groupId_"+h}));for(var p=0;p<t[h].series.length;p++)d.append(r.clone().addClass("groupId_"+h))}e.append(d)}(n,r.data,s,r.cellWidth,r.highlightWeekends,r.highlightToday),function(e,t){for(var a=w("<div>",{class:"ganttview-blocks"}),i=0;i<t.length;i++){a.append(w("<div>",{class:"ganttview-block-spacer"}));for(var n=0;n<t[i].series.length;n++)a.append(w("<div>",{class:"ganttview-block-container groupId_"+i}))}e.append(a)}(n,r.data),function(e,r,o,l){for(var c=w("div.ganttview-blocks div.ganttview-block-container",e),v=0,g=0;g<r.length;g++)for(var h,p,t,a,i,n,s,d,m=0;m<r[g].series.length;m++){r[g].series[m].sub_series?(h=r[g].series[m].sub_series,p=r[g].series[m].name.replace(/(<([^>]+)>)/gi," "),$.each(h,function(e,t){var a=f.daysBetween(t.start,t.end)+1,i=f.daysBetween(l,t.start),n=t.user_name?" ("+t.user_name+")":"",s=w("<div>",{class:"ganttview-block",title:p+n,"data-id":t.id,id:"ganttview-item-"+t.id,css:{width:a*o-7+"px",left:i*o+3+"px"}});u(s,r[g],h[e]),t.color&&s.css("background-color",t.color);var d=t.title?t.link?'<a href="'+t.link+'" title="'+t.link+'">'+t.title+"</a>":t.title:f.humanizeOutput(moment(t.start,"MM/DD/YYYY"),moment(t.end,"MM/DD/YYYY"));t.link?s.append(w("<div>",{class:"ganttview-block-text"}).html(d)):s.append(w("<div>",{class:"ganttview-block-text"}).text(d)),w(c[v]).append(s)})):(t=r[g].series[m],a=t.name.replace(/(<([^>]+)>)/gi," "),i=f.daysBetween(t.start,t.end)+1,n=f.daysBetween(l,t.start),u(s=w("<div>",{class:"ganttview-block",title:a,id:"ganttview-item-"+r[g].series[m].id,css:{width:i*o-7+"px",left:n*o+3+"px"}}),r[g],t),r[g].series[m].color&&s.css("background-color",r[g].series[m].color),d=t.title?t.link?'<a href="'+t.link+'" title="'+t.link+'">'+t.title+"</a>":t.title:f.humanizeOutput(moment(t.start,"MM/DD/YYYY"),moment(t.end,"MM/DD/YYYY")),t.link?s.append(w("<div>",{class:"ganttview-block-text"}).html(d)):s.append(w("<div>",{class:"ganttview-block-text"}).text(d)),w(c[v]).append(s)),v++}w(".ganttview-blocks").css({width:$(e).width()})}(n,r.data,r.cellWidth,r.start),d.append(n),w(d).find(".ganttview-blocks").width(n.find(".ganttview-grid").width()),e=d.parent(),w("div.ganttview-grid-row div.ganttview-grid-row-cell:last-child",e).addClass("last"),w("div.ganttview-hzheader-days div.ganttview-hzheader-day:last-child",e).addClass("last"),w("div.ganttview-hzheader-months div.ganttview-hzheader-month:last-child",e).addClass("last"),r.toggleableProjects&&(t=d,a=[.55,0,.1,1],$("div.ganttview-vtheader-group-name",t).addClass("toggle_enabled").on("click",function(){var e=$(this).attr("id");$(this).hasClass("projectHidden")?($(this).removeClass("projectHidden").next("div").children().velocity("slideDown",{duration:180,easing:a}),$(".ganttview-block-container."+e).show(),$(".ganttview-grid-row."+e).velocity("slideDown",{duration:180,easing:a})):($(this).addClass("projectHidden").next("div").children().velocity("slideUp",{duration:180,easing:a}),$(".ganttview-block-container."+e).hide(),$(".ganttview-grid-row."+e).velocity("slideUp",{duration:180,easing:a}))}),$("div.ganttview-grid-spacer",t).on("click",function(){$("#"+$(this).attr("data-click-target")).click()})),r.kineticScroll&&(i=w("div.ganttview-slide-container",d),$(i).kinetic({y:!1,filterTarget:function(e,t){return!($(e).closest(".ganttview-block").length||$(e).closest(".ganttview-grid-spacer").length)}})),r.startToday&&setTimeout(function(){var e=f.daysBetween(r.start,moment()._d);n.scrollLeft(e*r.cellWidth)},100)}}},s=function(c,v){function g(e,t,a,i){var n=w("div.ganttview-slide-container",e),s=n.scrollLeft(),d=t.offset().left-n.offset().left-1+s,r=Math.round(d/a),o=moment(i).add(r,"days");t.data("block-data").start=o;var l=t.outerWidth(),c=Math.round(l/a)-1,v=moment(o).add(c,"days");t.data("block-data").end=v,t.data("block-data").title||w("div.ganttview-block-text",t).text(f.humanizeOutput(o,v))}return{apply:function(){var e,t,a,i,n,s,d,r,o,l;v.behavior.clickable&&(e=c,t=v.behavior.onClick,w("div.ganttview-block",e).on("click",function(){t&&t(w(this).data("block-data"))})),v.behavior.resizable&&(a=c,i=v.cellWidth,n=v.start,s=v.behavior.onResize,w("div.ganttview-block",a).resizable({grid:i,handles:"e,w",stop:function(){var e=w(this);g(a,e,i,n);var t=e.data("block-data");a.find("[data-event-id="+t.id+"]").text(moment(t.start).format("D MMM")+" - "+moment(t.end).format("D MMM")),s&&s(e.data("block-data"))}})),v.behavior.draggable&&(d=c,r=v.cellWidth,o=v.start,l=v.behavior.onDrag,w("div.ganttview-block",d).draggable({axis:"x",grid:[r,r],containment:"parent",stop:function(){var e=w(this);g(d,e,r,o);var t=e.data("block-data");d.find("[data-event-id="+t.id+"]").text(moment(t.start).format("D MMM")+" - "+moment(t.end).format("D MMM")),l&&l(e.data("block-data"))}}))}}},f={daysBetween:function(e,t){return e&&t?(e=Date.parse(e),t=Date.parse(t),1901==moment(e)._d.getYear()||8099==moment(t)._d.getYear()?0:moment(t).diff(moment(e),"days")):0},isWeekend:function(e){return e.getDay()%6==0},getBoundaryDatesFromData:function(e,t){var n=new Date,s=new Date,a=[];return e.forEach(function(e){e.series.forEach(function(e){e.sub_series?e.sub_series.forEach(function(e){a.push(e)}):a.push(e)})}),a.forEach(function(e,t){var a=Date.parse(e.start),i=Date.parse(e.end);0===t&&(n=a,s=i),moment(n).isAfter(a)&&(n=a),moment(s).isBefore(i)&&(s=i)}),moment(s).diff(n,"days")<t&&(s=moment(n).add(t,"days")),[moment(n)._d,moment(s)._d]},humanizeOutput:function(e,t){var a=moment.duration(moment(t._d).diff(moment(e._d).subtract("1","day"))),i=a._locale._relativeTime.d,n=a._locale._relativeTime.dd,s=parseInt(a.asDays());return s=1<s?n.replace("%d",s):i}}}(jQuery);